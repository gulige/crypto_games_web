var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{h(n.next(t))}catch(e){s(e)}}function a(t){try{h(n["throw"](t))}catch(e){s(e)}}function h(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;h;)try{if(o=1,s&&(r=s[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(s,i[1])).done)return r;switch(s=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,s=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(r=h.trys,!(r=r.length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){h.label=i[1];break}if(6===i[0]&&h.label<r[1]){h.label=r[1],r=i;break}if(r&&h.label<r[2]){h.label=r[2],h.ops.push(i);break}r[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],s=0}finally{o=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,s,r,a,h={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},ItemUtils=function(t){function e(e,i,n){return t.call(this)||this}return __extends(e,t),e.createBitmapById=function(t){var e=new egret.Bitmap,i=RES.getRes(this.items["id_"+t].png);return e.texture=i,e.width=70,e.height=70,e},e.createItemById=function(t){var e=new Item(this.items["id_"+t].png);return e.setId(t),e},e.getItemNameById=function(t){var e=this.items["id_"+t].name;return e},e.items={id_0:{name:"",png:"empty_png"},id_1:{name:"炸弹",png:"explosive_png"},id_2:{name:"",png:"gun4_png"},id_3:{name:"手枪",png:"gun1_png"},id_4:{name:"步枪",png:"gun2_png"},id_5:{name:"超级步枪",png:"gun4_png"},id_6:{name:"一级防具",png:"shield1_png"},id_7:{name:"二级防具",png:"shield2_png"},id_8:{name:"三级防具",png:"shield3_png"},id_9:{name:"决斗卡",png:"combat_png"},id_10:{name:"复活卡",png:"rebirth_png"},id_11:{name:"药箱",png:"medicine_png"},id_12:{name:"急救箱",png:"first_aid_png"},id_13:{name:"",png:"money_png"},id_14:{name:"黄金矿点",png:"gold_png"}},e}(egret.HashObject);__reflect(ItemUtils.prototype,"ItemUtils");var Board=function(t){function e(e,i){var n=t.call(this)||this;return n.playerContainer=new egret.DisplayObjectContainer,n.colorMatrix=[.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0],n.createBoard(e,i),n}return __extends(e,t),e.prototype.createBoard=function(t,e){this.cellList=[];for(var i=0;t>i;i++)for(var n=0;e>n;n++){var o=this.createCell(i,n,this.cellList.length);this.addChild(o)}this.addChild(this.playerContainer)},e.prototype.createCell=function(t,e,i){var n=new Cell(t,e,i);return this.cellList.push(n),n},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getCellList=function(){return this.cellList},e.prototype.getCellById=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.cellList.filter(function(e){return e.getID()==t})];case 1:return e=i.sent(),[2,e[0]]}})})},e.prototype.getCellByXY=function(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){switch(n.label){case 0:return[4,this.cellList.filter(function(i){var n=i.getXY();return n.x==t&&n.y==e})];case 1:return i=n.sent(),[2,i[0]]}})})},e.prototype.putPlayer=function(t){this.playerContainer.addChild(t)},e.prototype.clearPlayers=function(){this.playerContainer.removeChildren()},e.prototype.removePlayer=function(t){this.playerContainer.removeChild(t)},e.prototype.setIndex=function(t,e){this.playerContainer.setChildIndex(t,e)},e}(egret.DisplayObjectContainer);__reflect(Board.prototype,"Board");var Game=function(t){function e(){var e=t.call(this)||this;return e._touchStatus=!1,e._distance=new egret.Point,e.textfield=new egret.TextField,e.tmxTileMap=tiled.TMXTilemap,e._route=new egret.Shape,e._life=new egret.Shape,e.soilderIconList=[],e.board=null,e.backgroundMusic=new egret.Sound,e.playerInfo=new egret.Shape,e.player_name=new egret.TextField,e.player_hp=new egret.TextField,e.player_attack=new egret.TextField,e.player_defense=new egret.TextField,e.player_eos=new egret.TextField,e.player_item=new egret.TextField,e.player_weapon=new egret.TextField,e.safeAreaTop=new egret.Shape,e.safeAreaLeft=new egret.Shape,e.safeAreaRight=new egret.Shape,e.safeAreaBottom=new egret.Shape,e.playerProfileListContainer=new egret.DisplayObjectContainer,e.honorListContainer=new egret.DisplayObjectContainer,e.honorListBox=new egret.Shape,e.honorListText=new egret.TextField,e.summaryContainer=new egret.DisplayObjectContainer,e.summaryBox=new egret.Shape,e.summaryContent=new egret.TextField,e.cellDetailsContainer=new egret.DisplayObjectContainer,e.cellDetailsBox=new egret.Shape,e.cellDetailsContent=new egret.TextField,e.messageContainer=new egret.DisplayObjectContainer,e.messageBox=new egret.Shape,e.message=new egret.TextField,e.moveZoneContainer=new egret.DisplayObjectContainer,e.moveZoneBox=new egret.Shape,e.townRandomName=["johny","kitty","peter"],e.num=0,e.interval=null,e.messageTimeout=null,e.poisons=[],e.colorFlilter=new egret.ColorMatrixFilter([.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0]),e.canvas=document.getElementsByTagName("CANVAS")[0],e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return console.log("url",window.location.href),[4,this.loadResource()];case 1:return t.sent(),this.createGameScene(),[4,RES.loadConfig("resource/lazy.res.json","resource/")];case 2:return t.sent(),[4,RES.loadGroup("lazy",0)];case 3:return t.sent(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,s,r,a,h,l,c=this;return __generator(this,function(u){return t=this.createBitmapByName("town_png"),this.stage.addChild(t),t.width=80,t.height=80,t.x=10,t.y=5,t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){document.location.href="index.html"},this),this.setMapFlat=this.createBitmapByName("setmap_png"),this.setMapFlat.width=80,this.setMapFlat.height=80,this.setMapFlat.x=10,this.setMapFlat.y=115,this.setMapFlat.touchEnabled=!0,this.setMapFlat.addEventListener(egret.TouchEvent.TOUCH_TAP,this.setMap,this),this.kickOffFlat=this.createBitmapByName("kickoff_png"),this.kickOffFlat.x=10,this.kickOffFlat.y=220,this.kickOffFlat.touchEnabled=!0,this.kickOffFlat.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){c.kickOff.call(c),c.currentHouse.getPlayerList().map(function(t){t.setMoveable(!0)})},this),this.summaryContainer.x=1200,this.summaryContainer.y=100,this.summaryContainer.width=250,this.summaryContainer.height=100,this.stage.addChild(this.summaryContainer),this.summaryBox.graphics.clear(),this.summaryBox.graphics.beginFill(16240036,.2),this.summaryBox.graphics.lineStyle(2,0,.5),this.summaryBox.graphics.drawRoundRect(0,0,250,100,15,15),this.summaryBox.graphics.endFill(),this.summaryContainer.addChild(this.summaryBox),e=new egret.Shape,e.graphics.beginFill(5197647,.8),e.graphics.drawRoundRect(0,0,250,30,15,15),this.summaryContainer.addChild(e),i=new egret.TextField,i.x=100,i.y=5,i.size=20,i.textColor=16777215,i.text="统计栏",this.summaryContainer.addChild(i),this.summaryContent.x=10,this.summaryContent.y=35,this.summaryContent.width=250,this.summaryContent.height=100,this.summaryContent.size=20,this.summaryContent.textColor=0,this.summaryContent.$setWordWrap(!0),this.summaryContent.$setMultiline(!0),this.summaryContent.restrict="",this.summaryContainer.addChild(this.summaryContent),this.messageContainer.x=1200,this.messageContainer.y=210,this.messageContainer.width=250,this.messageContainer.height=250,this.stage.addChild(this.messageContainer),this.messageBox.graphics.clear(),this.messageBox.graphics.beginFill(16240036,.4),this.messageBox.graphics.lineStyle(2,0,.5),this.messageBox.graphics.drawRoundRect(0,0,250,250,15,15),this.messageBox.graphics.endFill(),this.messageContainer.addChild(this.messageBox),n=new egret.Shape,n.graphics.beginFill(5197647,.8),n.graphics.drawRoundRect(0,0,250,30,15,15),this.messageContainer.addChild(n),o=new egret.TextField,o.x=100,o.y=5,o.size=20,o.textColor=16777215,o.text="消息栏",this.messageContainer.addChild(o),this.message.x=10,this.message.y=35,this.message.width=230,this.message.height=200,this.message.size=20,this.message.textColor=0,this.message.$setWordWrap(!0),this.message.$setMultiline(!0),this.messageContainer.addChild(this.message),this.cellDetailsContainer.x=1200,this.cellDetailsContainer.y=470,this.cellDetailsContainer.width=250,this.cellDetailsContainer.height=500,this.cellDetailsBox.graphics.clear(),this.cellDetailsBox.graphics.beginFill(16240036,.4),this.cellDetailsBox.graphics.lineStyle(2,0,.5),this.cellDetailsBox.graphics.drawRoundRect(0,0,250,500,15,15),this.cellDetailsBox.graphics.endFill(),this.cellDetailsContainer.addChild(this.cellDetailsBox),s=new egret.Shape,s.graphics.beginFill(5197647,.8),s.graphics.drawRoundRect(0,0,250,30,15,15),this.cellDetailsContainer.addChild(s),r=new egret.TextField,r.x=100,r.y=5,r.size=20,r.textColor=16777215,r.text="格子栏",this.cellDetailsContainer.addChild(r),this.cellDetailsContent.x=10,this.cellDetailsContent.y=35,this.cellDetailsContent.width=230,this.cellDetailsContent.height=450,this.cellDetailsContent.size=20,this.cellDetailsContent.textColor=0,this.cellDetailsContent.$setWordWrap(!0),this.cellDetailsContent.$setMultiline(!0),this.cellDetailsContainer.addChild(this.cellDetailsContent),this.moveZoneContainer.width=240,this.moveZoneContainer.height=240,this.moveZoneBox.graphics.clear(),this.moveZoneBox.graphics.beginFill(255,.1),this.moveZoneBox.graphics.drawRoundRect(0,0,240,240,15,15),this.moveZoneBox.graphics.endFill(),this.moveZoneContainer.addChild(this.moveZoneBox),this.honorListContainer.width=880,this.honorListContainer.height=880,this.honorListBox.graphics.clear(),this.honorListBox.graphics.beginFill(4473924,.8),this.honorListBox.graphics.drawRoundRect(0,0,880,880,15,15),this.honorListBox.graphics.endFill(),this.honorListContainer.addChild(this.honorListBox),this.honorListContainer.addChild(this.createBitmapByName("gameover_jpg")),this.honorListText.width=880,this.honorListText.height=880,this.honorListText.size=22,this.honorListText.textColor=16777215,this.honorListText.$setWordWrap(!0),this.honorListText.$setMultiline(!0),this.honorListContainer.addChild(this.honorListText),this.login=this.createBitmapByName("login_png"),this.login.x=1200,this.login.y=10,this.login.touchEnabled=!0,this.login.addEventListener(egret.TouchEvent.TOUCH_TAP,this.loginGame,this),this.logout=this.createBitmapByName("logout_png"),this.logout.x=1200,this.logout.y=10,this.logout.touchEnabled=!0,this.logout.addEventListener(egret.TouchEvent.TOUCH_TAP,this.logoutGame,this),ScatterUtils.getIdentity().then(function(t){null==t?c.stage.addChild(c.login):(ScatterUtils.login(),c.stage.addChild(c.logout))}),this.show=this.createBitmapByName("show_png"),this.show.x=1350,this.show.y=10,this.show.width=40,this.show.height=40,this.show.touchEnabled=!0,this.show.$setVisible(!1),this.stage.addChild(this.show),this.show.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){c.show.$setVisible(!1),c.hide.$setVisible(!0),c.changeDetailMode(!1)},this),this.hide=this.createBitmapByName("hide_png"),this.hide.x=1350,this.hide.y=10,this.hide.width=40,this.hide.height=40,this.hide.touchEnabled=!0,this.stage.addChild(this.hide),this.hide.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){c.show.$setVisible(!0),c.hide.$setVisible(!1),c.changeDetailMode(!0)},this),a=this.createBitmapByName("music_png"),this.stage.addChild(a),a.x=1400,a.y=5,a.touchEnabled=!0,a.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){c.backgroundMusicChannel&&c.backgroundMusicChannel.stop(),a.$setVisible(!1),h.$setVisible(!0)},this),this.stage.addChild(a),this.backgroundSound(RES.getRes("easy_1_mp3").url),h=this.createBitmapByName("mute_png"),this.stage.addChild(h),h.$setVisible(!1),h.x=1400,h.y=5,h.touchEnabled=!0,h.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){c.backgroundSound(RES.getRes("easy_1_mp3").url),a.$setVisible(!0),h.$setVisible(!1)},this),this.stage.addChild(this.textfield),l=window.location.href.substr(window.location.href.indexOf("=")+1),this.initBoard().then(function(){c.refreshHouse(l),c.interval=egret.setInterval(function(){return __awaiter(c,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return[4,this.refreshHouse(l)];case 1:return i.sent(),this.updateSummaryBoard(),t=this.currentHouse.getProgress(),3==t&&(egret.setTimeout(function(){e.popHonorList()},this,5e3),this.interval&&egret.clearInterval(this.interval)),[2]}})})},c,5e3)}),[2]})})},e.prototype.updateButton=function(){var t=this.currentHouse.getOwner()==ScatterUtils.getCurrentAccountName();if(t){this.stage.contains(this.setMapFlat)||(this.stage.addChild(this.setMapFlat),this.stage.addChild(this.kickOffFlat));var e=this.currentHouse.getProgress();0===e?(this.kickOffFlat.touchEnabled=!1,this.kickOffFlat.filters=[this.colorFlilter]):1===e?(this.setMapFlat.touchEnabled=!1,this.setMapFlat.filters=[this.colorFlilter],this.kickOffFlat.touchEnabled=!0,this.kickOffFlat.filters=[]):(this.setMapFlat.touchEnabled=!1,this.setMapFlat.filters=[this.colorFlilter],this.kickOffFlat.touchEnabled=!1,this.kickOffFlat.filters=[this.colorFlilter])}else this.stage.contains(this.setMapFlat)&&(this.stage.removeChild(this.setMapFlat),this.stage.removeChild(this.kickOffFlat))},e.prototype.initBoard=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){return null==this.board&&(this.board=new Board(11,11),this.board.x=300,this.board.y=100,this.stage.addChild(this.board),t=this.board.getCellList(),t.map(function(t){var i=t.getXY();t.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){if(null!=e.currentHouse)if(t.onDetailMode())e.showCellDetails(t.getID());else{var n=e.currentHouse.getProgress();0==n||(1==n?e.currentHouse.getPlayerByName(ScatterUtils.getCurrentAccountName()).then(function(n){null===n&&e.joinGame(i.x,i.y,t.getPosition())}):2==n&&e.currentHouse.getPlayerByName(ScatterUtils.getCurrentAccountName()).then(function(n){null!==n&&n.isMoveable()&&e.move(i.x,i.y,t.getPosition())}))}},e)})),[2]})})},e.prototype.changeDetailMode=function(t){1==t?this.stage.addChild(this.cellDetailsContainer):this.stage.contains(this.cellDetailsContainer)&&this.stage.removeChild(this.cellDetailsContainer);var e=this.board.getCellList();e.map(function(e){e.showDetailMode(t)})},e.prototype.showCellDetails=function(t){return __awaiter(this,void 0,void 0,function(){var e,i=this;return __generator(this,function(n){switch(n.label){case 0:return this.cellDetailsContent.text="",[4,this.currentHouse.getFullPlayersJsonByCellId(t)];case 1:return e=n.sent(),e.map(function(t){i.currentHouse.getPlayerByName(t.acc_name).then(function(t){if(t.isAlive()){var e=function(){var e="";return t.getItems().map(function(t){e=e+ItemUtils.getItemNameById(t)+"\n         "}),e};i.cellDetailsContent.text=i.cellDetailsContent.text+("玩家: "+t.getName()+"\n")+("HP: "+t.getLife()+"\n")+("武器: "+ItemUtils.getItemNameById(t.getWeapon())+"\n")+("攻击力: "+t.getAttack()+"\n")+("防御力: "+t.getDefense()+"\n")+("EOS: "+t.getGold()/1e4+"\n")+("物品: "+e()+"\n\n")}})}),[2]}})})},e.prototype.selectPlayer=function(t){this.board.setIndex(t,1);var e=t.getGentle();0==e?this.actionSound(RES.getRes("yes_mp3").url):this.actionSound(RES.getRes("yes_female_mp3").url);var i=function(){var e="";return t.getItems().map(function(t){e=e+ItemUtils.getItemNameById(t)+"\n         "}),e},n="玩家: "+t.getName()+"\n"+("HP: "+t.getLife()+"\n")+("武器: "+ItemUtils.getItemNameById(t.getWeapon())+"\n")+("攻击力: "+t.getAttack()+"\n")+("防御力: "+t.getDefense()+"\n")+("EOS: "+t.getGold()/1e4+"\n")+("物品: "+i()+"\n\n");this.popMessageBox(n)},e.prototype.popMessageBox=function(t){var e=this;egret.clearTimeout(this.messageTimeout),this.messageTimeout=egret.setTimeout(function(){e.message.text=""},this,4e3),this.message.text=t},e.prototype.popHonorList=function(){this.board.addChild(this.honorListContainer),this.honorListText.y=150,this.honorListText.text="本局赢家: "+this.currentHouse.getWinner()+"\n"+("最佳杀手:  "+this.currentHouse.getBestKiller()+"\n")+("最多EOS赢家: "+this.currentHouse.getBestEOSWin())},e.prototype.updateSummaryBoard=function(){this.currentHouse.getPlayerJsonList();this.summaryContent.text="总玩家数: "+this.currentHouse.getTotalJoinPlayers()+"\n"+("总EOS数: "+(this.currentHouse.getEOSInHouse()+".0000")+"\n")+("生存玩家: "+this.currentHouse.getAlivePlayers())},e.prototype.createSafeAreaInBoard=function(t){var e=this;this.board.contains(this.safeAreaTop)||(this.board.addChild(this.safeAreaTop),this.board.addChild(this.safeAreaLeft),this.board.addChild(this.safeAreaRight),this.board.addChild(this.safeAreaBottom)),this.safeAreaTop.graphics.clear(),this.safeAreaTop.graphics.beginFill(65280,.2),this.safeAreaTop.graphics.drawRect(0,0,this.board.width,80*(5-t)),this.safeAreaTop.graphics.endFill(),this.safeAreaLeft.graphics.clear(),this.safeAreaLeft.graphics.beginFill(65280,.2),this.safeAreaLeft.graphics.drawRect(0,80*(5-t),80*(5-t),this.board.height-80*(5-t)*2),this.safeAreaLeft.graphics.endFill(),this.safeAreaRight.graphics.clear(),this.safeAreaRight.graphics.beginFill(65280,.2),this.safeAreaRight.graphics.drawRect(this.board.width-80*(5-t),80*(5-t),80*(5-t),this.board.height-80*(5-t)*2),this.safeAreaRight.graphics.endFill(),this.safeAreaBottom.graphics.clear(),this.safeAreaBottom.graphics.beginFill(65280,.2),this.safeAreaBottom.graphics.drawRect(0,this.board.height-80*(5-t),this.board.width,80*(5-t)),this.safeAreaBottom.graphics.endFill();var i=5-t;if(this.poisons.length<4*i)for(var n=this.poisons.length/4;i>n;n++)for(var o=function(t){var i,o;0==t?(i={x:0,y:80*n},o={x:800,y:80*n}):1==t?(i={x:80*n,y:0},o={x:80*n,y:800}):2==t?(i={x:800-80*n,y:800},o={x:800-80*n,y:0}):3==t&&(i={x:800,y:800-80*n},o={x:0,y:800-80*n}),s.animation({json:"poison_json",png:"poison_png",data:"poison",x:i.x,y:i.y}).then(function(t){t.$setScaleX(.6),t.$setScaleY(.6),t.$alpha=.5,t.play(-1),e.board.addChild(t),e.poisons.push(t),a(t,i,o)})},s=this,r=0;4>r;r++)o(r);var a=function(t,i,n){egret.Tween.get(t).to(n,6e3+4e3*Math.random(),egret.Ease.sineIn).wait(0).call(a.bind(e,t,n,i))}},e.prototype.updateObjectsInBoard=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,n,o,s=this;return __generator(this,function(r){switch(r.label){case 0:return this.board.clearPlayers(),e=t.getBoard(),i=this.board.getCellList(),n=t.getProgress(),o=t.getStep(),[4,i.map(function(i,r){return __awaiter(s,void 0,void 0,function(){var s,a,h,l,c,u,d,p,g,f,m,y=this;return __generator(this,function(_){switch(_.label){case 0:return s=e[r],[4,i.getItem()];case 1:return a=_.sent(),h=s.item,[4,ItemUtils.createItemById(h)];case 2:return l=_.sent(),[4,t.getFullPlayersJsonByCellId(i.getID())];case 3:return c=_.sent(),c.length>0?(u=function(){return __awaiter(y,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return[4,s.event_list.filter(function(t){return"move"==t.evt||"join"==t.evt})];case 1:return t=i.sent(),t.length>0?(e=t[t.length-1].who,[2,e]):[2,null]}})})},[4,u()]):[3,6];case 4:return d=_.sent(),[4,c.map(function(e){t.getPlayerByName(e.acc_name).then(function(t){if(t.isAlive()){0==t.x&&0==t.y&&t.setPosition(new egret.Point(i.x+10*Math.random(),i.y+10*Math.random())),y.board.putPlayer(t),t.getName()==d?y.board.setIndex(t,1):y.board.setIndex(t,0);var e=t.getName();if(e!==ScatterUtils.getCurrentAccountName()){var n=t.x-i.x,o=t.y-i.y;if(n>0&&80>n&&o>0&&80>o)egret.Tween.get(t).to({x:i.x+10*Math.random(),y:i.y+10*Math.random()},500,egret.Ease.sineIn);else{var s=void 0;s=t.x>i.x?"horse-left_png":"horse_png",t.$setVisible(!1),y.animation({json:"horse_json",png:s,data:"horse",x:t.x,y:t.y}).then(function(e){y.board.addChild(e),e.$setScaleX(.8),e.$setScaleY(.8),e.play(-1);var n={x:i.x+10*Math.random(),y:i.y+10*Math.random()};egret.Tween.get(e).to(n,500,egret.Ease.sineIn).wait(0).call(function(){y.board.removeChild(e),t.$setVisible(!0),t.setPosition(n)})})}}}})})];case 5:_.sent(),2==n&&null!=a&&null!=l&&this.checkCellItemEffect(i,a,l),3==n?(p=e[60].event_list,g=p[p.length-1],this.checkBattersInCell(g.progress,g.step,s.event_list,i)):this.checkBattersInCell(n,o,s.event_list,i),_.label=6;case 6:return f=s.item_drop_ticks,m=s.item_drop_triggered,1===m&&(0!==f?(i.hasFallDownSign()||this.animation({json:"arrow-down_json",png:"arrow-down_png",data:"arrow-down",x:30,y:30}).then(function(t){t.play(-1),i.addChild(t),i.addFallDownSign(!0)}),this.popMessageBox(ItemUtils.getItemNameById(l.getId())+"即将降落")):i.removeChildren()),0!=f?[3,8]:(l.x=15,l.y=15,[4,i.addItem(l)]);case 7:_.sent(),1!=m||null===a||0!==a.getId()||5!=h&&8!=h&&13!=h||(l.y=-300,egret.Tween.get(l).to({x:0,y:0},1500,egret.Ease.sineIn).wait(0).call(function(){y.actionSound(RES.getRes("item_fall_mp3").url)})),_.label=8;case 8:return[2]}})})})];case 1:return r.sent(),[2]}})})},e.prototype.updatePlayerProfileInStage=function(t){var e=this;this.stage.contains(this.playerProfileListContainer)||(this.stage.addChild(this.playerProfileListContainer),this.playerProfileListContainer.x=300,this.playerProfileListContainer.y=10),this.playerProfileListContainer.removeChildren(),t.map(function(t,i){var n;n=t.getName()==ScatterUtils.getCurrentAccountName()?e.createBitmapByName("portraitFrame_self_png"):e.createBitmapByName("portraitFrame_png"),n.$setX(80*i+5),n.$setY(6),n.$setWidth(72),n.$setHeight(68);var o=t.getPlayerProfile().texture,s=new egret.Bitmap(o);s.$setX(80*i),s.$setY(0),s.$setWidth(80),s.$setHeight(72),e.playerProfileListContainer.addChild(n),e.playerProfileListContainer.addChild(s),t.isAlive()?(s.touchEnabled=!0,s.addEventListener(egret.TouchEvent.TOUCH_TAP,e.selectPlayer.bind(e,t),e)):s.filters=[e.colorFlilter]})},e.prototype.refreshHouse=function(t){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(i){switch(i.label){case 0:return[4,ScatterUtils.getGameInfo(parseInt(t)).then(function(t){return __awaiter(e,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return console.log(t),t.rows.length>0?(e=t.rows[0],null!=this.currentHouse?[3,1]:(this.currentHouse=new House({name:"johny",bitmap:"house_png"},e),[3,3])):[3,5];case 1:return[4,this.currentHouse.updateHouse(e)];case 2:i.sent(),i.label=3;case 3:return[4,this.updateObjectsInBoard(this.currentHouse)];case 4:return i.sent(),this.createSafeAreaInBoard(this.currentHouse.getSafeAreaRadius()),this.updatePlayerProfileInStage(this.currentHouse.getPlayerList()),this.updateButton(),this.checkMoveZone(),[3,6];case 5:this.currentHouse=null,this.popMessageBox("无游戏信息"),i.label=6;case 6:return[2]}})})})["catch"](function(t){console.error(t),e.currentHouse=null,e.popMessageBox("获取游戏信息失败")})];case 1:return i.sent(),[2]}})})},e.prototype.joinGame=function(t,e,i){var n=this;ScatterUtils.getIdentity().then(function(o){return null==o?void n.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.joinGame(n.currentHouse.getID(),n.currentHouse.getJoinEos(),t,e).then(function(t){if(console.log("transaction",t),t.processed){n.popMessageBox("加入游戏！");var e=new Player("jump_png",{});n.board.putPlayer(e),e.setPosition(new egret.Point(i.x,i.y-300)),egret.Tween.get(e).to(i,300,egret.Ease.sineIn).wait(0).call(function(){n.actionSound(RES.getRes("player_fall_mp3").url)})}else t=JSON.parse(t),n.popMessageBox("加入游戏失败:"+t.error.details[0].message)})["catch"](function(t){console.error(t),n.popMessageBox("加入游戏失败:"+t)})})},e.prototype.setMap=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.getIdentity().then(function(e){return null==e?void t.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.setMap(t.currentHouse.getID()).then(function(e){console.log("result",e),1==e.succ?t.popMessageBox("棋盘地图设定成功！"):t.popMessageBox("棋盘地图已经设定")})}),[2]})})},e.prototype.move=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(o){return ScatterUtils.getIdentity().then(function(o){return null==o?void n.popMessageBox(ScatterUtils.message.authority):void n.animation({json:"arrow-down_json",png:"arrow-down_png",data:"arrow-down",x:i.x+30,y:i.y+25}).then(function(o){n.board.addChild(o),o.$setScaleX(1.5),o.$setScaleY(1.5),o.play(-1),ScatterUtils.move(n.currentHouse.getID(),t,e).then(function(t){return __awaiter(n,void 0,void 0,function(){var e=this;return __generator(this,function(n){return t.processed?this.currentHouse.getPlayerByName(ScatterUtils.getCurrentAccountName()).then(function(t){if(null!=t){var n=void 0;n=t.x>i.x?"horse-left_png":"horse_png",t.$setVisible(!1),e.animation({json:"horse_json",png:n,data:"horse",x:t.x,y:t.y}).then(function(n){e.board.addChild(n),n.$setScaleX(.8),n.$setScaleY(.8),n.play(-1),egret.Tween.get(n).to(i,500,egret.Ease.sineIn).wait(0).call(function(){e.board.removeChild(n),e.board.removeChild(o),t.setPosition(i),t.$setVisible(!0)})}),t.setMoveable(!1),e.checkMoveZone()}}):(t=JSON.parse(t),this.popMessageBox("移动失败"),this.board.removeChild(o)),[2]})})})["catch"](function(t){console.error(t),n.popMessageBox("移动失败"),n.board.removeChild(o)})})}),[2]})})},e.prototype.checkMoveZone=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return this.currentHouse.getPlayerByName(ScatterUtils.getCurrentAccountName()).then(function(e){if(null!=e){var i=e.isMoveable();i?t.board.getCellById(e.getCellId()).then(function(i){t.moveZoneContainer.x=i.getPosition().x-80,t.moveZoneContainer.y=i.getPosition().y-80,t.board.addChild(t.moveZoneContainer),t.popMessageBox("玩家"+e.getName()+"可以移动")}):t.board.contains(t.moveZoneContainer)&&t.board.removeChild(t.moveZoneContainer)}}),[2]})})},e.prototype.checkBattersInCell=function(t,e,i,n){return __awaiter(this,void 0,void 0,function(){var o,s,r;return __generator(this,function(a){switch(a.label){case 0:return[4,i.filter(function(i){return i.progress==t&&i.step==e&&"attack"==i.evt})];case 1:return o=a.sent(),console.log("attact_evt",o),o.length>0&&(s=n.getBattleTime(),r=(new Date).getTime(),r-s>=3e4&&(n.setBattleTime(r),this.attackTarget(n.getPosition()))),[2]}})})},e.prototype.checkCellItemEffect=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(o){return 1==e.getId()&&0==i.getId()&&this.animation({json:"explosion_json",png:"explosion_png",data:"explosion",x:t.x-20,y:t.y-30}).then(function(i){n.board.addChild(i),i.play(1),t.contains(e)&&t.removeChild(e),n.actionSound(RES.getRes("blow_mp3").url),n.actionSound(RES.getRes("destroyhuman_wav").url),setTimeout(function(){n.board.removeChild(i)},1e3)}),[2]})})},e.prototype.kickOff=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.getIdentity().then(function(e){return null==e?void t.popMessageBox(ScatterUtils.message.authority):t.currentHouse?void ScatterUtils.kickOff(t.currentHouse.getID()).then(function(e){console.log(e),e.processed?t.popMessageBox("游戏启动成功！"):(e=JSON.parse(e),t.popMessageBox("启动游戏失败："+e.error.details[0].message))}):(console.log("no house selected"),void t.popMessageBox("游戏失效"))}),[2]})})},e.prototype.loginGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.login().then(function(e){e.login?(t.animation({json:"identity_json",png:"identity_png",data:"identity",x:150,y:280}).then(function(i){var n=new egret.Shape;n.graphics.beginFill(4473924,.8),n.graphics.drawRoundRect(0,0,880,880,15,15),n.graphics.endFill(),i.$setScaleX(1.5),i.$setScaleY(1.5),i.play(1),t.board.addChild(n),t.board.addChild(i),egret.setTimeout(function(){t.board.removeChild(i),t.board.removeChild(n),t.popMessageBox("欢迎: "+e.details)},t,8e3)}),t.stage.contains(t.login)&&t.stage.removeChild(t.login),t.stage.contains(t.logout)||t.stage.addChild(t.logout)):t.popMessageBox(e.details)})["catch"](function(e){console.log("e",e),t.popMessageBox(e)}),[2]})})},e.prototype.logoutGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.logout().then(function(e){t.popMessageBox(e.details),e.logout&&(t.stage.contains(t.logout)&&t.stage.removeChild(t.logout),t.stage.contains(t.login)||t.stage.addChild(t.login))})["catch"](function(e){console.log("e",e),t.popMessageBox(e)}),[2]})})},e.prototype.animation=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){return e=new egret.MovieClipDataFactory(RES.getRes(t.json),RES.getRes(t.png)),i=new egret.MovieClip(e.generateMovieClipData(t.data)),i.x=t.x,i.y=t.y,[2,i]})})},e.prototype.showPlayerInfo=function(t){var e=this;this.board.contains(this.playerInfo)&&this.board.removeChild(this.playerInfo),this.playerInfo.graphics.clear(),this.playerInfo.graphics.beginFill(15658734),this.playerInfo.graphics.drawRoundRect(0,0,120,160,15,15),this.playerInfo.graphics.endFill(),this.playerInfo.x=t.x+50,this.playerInfo.y=t.y,this.board.addChild(this.playerInfo),this.player_name.x=this.playerInfo.x,this.player_name.y=this.playerInfo.y,this.player_name.size=18,this.player_name.textColor=0,this.player_name.text="玩家:"+t.getName(),this.board.addChild(this.player_name),this.player_hp.x=this.playerInfo.x,this.player_hp.y=this.playerInfo.y+20,this.player_hp.size=18,this.player_hp.textColor=0,this.player_hp.text="HP: "+t.getLife(),this.board.addChild(this.player_hp),this.player_weapon.x=this.playerInfo.x,this.player_weapon.y=this.playerInfo.y+40,this.player_weapon.size=18,this.player_weapon.textColor=0,this.player_weapon.text="武器: "+ItemUtils.getItemNameById(t.getWeapon()),this.board.addChild(this.player_weapon),this.player_attack.x=this.playerInfo.x,this.player_attack.y=this.playerInfo.y+60,this.player_attack.size=18,this.player_attack.textColor=0,this.player_attack.text="攻击力: "+t.getAttack(),this.board.addChild(this.player_attack),this.player_defense.x=this.playerInfo.x,this.player_defense.y=this.playerInfo.y+80,this.player_defense.size=18,this.player_defense.textColor=0,this.player_defense.text="防御力: "+t.getDefense(),this.board.addChild(this.player_defense),this.player_eos.x=this.playerInfo.x,this.player_eos.y=this.playerInfo.y+100,this.player_eos.size=18,this.player_eos.textColor=0,this.player_eos.text="EOS: "+t.getGold(),this.board.addChild(this.player_eos);var i=function(){var e="";return t.getItems().map(function(t){e=e+ItemUtils.getItemNameById(t)+"\n         "
}),e};this.player_item.x=this.playerInfo.x,this.player_item.y=this.playerInfo.y+120,this.player_item.size=18,this.player_item.textColor=0,this.player_item.text="物品: "+i(),this.board.addChild(this.player_item),setTimeout(function(){e.board.removeChild(e.playerInfo),e.board.removeChild(e.player_name),e.board.removeChild(e.player_hp),e.board.removeChild(e.player_weapon),e.board.removeChild(e.player_attack),e.board.removeChild(e.player_defense),e.board.removeChild(e.player_eos),e.board.removeChild(e.player_item)},8e3)},e.prototype.recall=function(t){if(t||(t=this.selectedPlayer),t){this.unmountMovement(),this.clearRoute(t.getTask().action);var e=t.getTask().status,i=t.getHouse(),n=i.getPosition(),o=t.getBitmap();egret.Tween.removeTweens(o),e&&"completed"==e?egret.Tween.get(o).to(n,1e3,egret.Ease.sineIn):egret.Tween.get(o).to(n,0,egret.Ease.sineIn),t.setTask({action:"idle",target:null,status:null})}},e.prototype.initTask=function(t){var e=this;this.selectedPlayer?(this.unmountMovement(),this.selectedPlayer.setTask({action:t,target:null,status:null}),setTimeout(function(){e.mountMovement()},300)):console.log("no warrior selected")},e.prototype.showLife=function(t,e){var i,n=e.getLife();i=n.remain>=.6*n.full?60928:n.remain>=.4*n.full&&n.remain<.6*n.full?16776960:16711680,this._life.graphics.clear(),this._life.graphics.lineStyle(4,i),this._life.graphics.moveTo(e.getPosition().x,e.getPosition().y),this._life.graphics.lineTo(e.getPosition().x+n.remain,e.getPosition().y),t.addChild(this._life)},e.prototype.showText=function(t,e){this.textfield.x=e.x,this.textfield.y=e.y,this.textfield.size=22,this.textfield.textColor=0,this.textfield.text=t},e.prototype.selectSoulder=function(t){this.board.setIndex(t,1),this.actionSound(RES.getRes("yes_mp3").url);var e="玩家: "+t.getName()+"\n"+("HP: "+t.getLife()+"\n")+("武器: "+ItemUtils.getItemNameById(t.getWeapon())+"\n")+("攻击力: "+t.getAttack()+"\n")+("防御力: "+t.getDefense()+"\n")+("EOS: "+t.getGold()+"\n\n");this.popMessageBox(e)},e.prototype.actionSound=function(t){var e=new egret.Sound;e.addEventListener(egret.Event.COMPLETE,function(t){e.play(0,1)},this),e.load(t)},e.prototype.backgroundSound=function(t){this.backgroundMusicChannel&&this.backgroundMusicChannel.stop(),this.backgroundMusic.addEventListener(egret.Event.COMPLETE,this.play,this),this.backgroundMusic.load(t)},e.prototype.play=function(){this.backgroundMusicChannel=this.backgroundMusic.play(0,0)},e.prototype.movePlayer=function(t){if(console.log("moving"),null!=this.selectedPlayer&&"undefined"!=typeof this.selectedPlayer){this.stage.contains(this._life)&&this.stage.removeChild(this._life);var e=this.selectedPlayer.getBitmap();egret.Tween.removeTweens(e);var i={x:e.x,y:e.y},n={x:t.stageX,y:t.stageY},o=this.selectedPlayer.getTask().action;this.drawRoute(i,n,o);var s={x:t.stageX-17,y:t.stageY-25};egret.Tween.get(e).to(s,3e3,egret.Ease.sineIn).wait(500).call(this.doAction.bind(this,this.selectedPlayer,o,s,n))}},e.prototype.mountMovement=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.unmountMovement=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.doAction=function(t,e,i,n){var o=this;this.clearRoute(e);var s=t.getTask().target,r=null==s||null==s.getBitmap()?!1:s.getBitmap().hitTestPoint(n.x,n.y,!0);if(console.log("execute="+r),r){var a=this.createBitmapByName("sword_png");a.x=i.x,a.y=i.y,this.stage.addChild(a),"attack"==e?this.attackTarget(i).then(function(){t.setTask({action:"attack",target:null,status:"completed"}),o.recall(t)}):t.setTask({action:"enforce",target:s,status:"completed"}),setTimeout(function(){o.stage.removeChild(a),a=null},1e3)}else t.setTask({action:"idle",target:null})},e.prototype.attackTarget=function(t){var e=this,i=new egret.MovieClipDataFactory(RES.getRes("fighting_json"),RES.getRes("fighting_png")),n=new egret.MovieClip(i.generateMovieClipData("fighting"));n.x=t.x-20,n.y=t.y-25,this.board.addChild(n),n.play(5),this.actionSound(RES.getRes("shooting_mp3").url);var o=new egret.MovieClipDataFactory(RES.getRes("money_json"),RES.getRes("money_png")),s=new egret.MovieClip(o.generateMovieClipData("money"));return s.x=t.x,s.y=t.y-30,this.board.addChild(s),s.play(2),this.actionSound(RES.getRes("destroyhuman_wav").url),setTimeout(function(){e.board.removeChild(s)},2e3),new Promise(function(t,i){setTimeout(function(){e.board.removeChild(n),e.board.contains(e._life)&&e.board.removeChild(e._life),t()},7e3)})},e.prototype.drawRoute=function(t,e,i){this.clearRoute(i);var n,o,s;switch(i){case"attack":n=16711680,o=25,s=25;break;case"enforce":n=60928,o=10,s=50;break;default:n=16776960,o=10,s=50}this._route.graphics.lineStyle(2,n),this._route.graphics.moveTo(t.x,t.y),this._route.graphics.lineTo(e.x,e.y),this[i].x=e.x-o,this[i].y=e.y-s,this.stage.addChild(this[i])},e.prototype.clearRoute=function(t){this._route.graphics.clear(),this.stage.contains(this[t])&&this.stage.removeChild(this[t]),this.stage.contains(this._life)&&this.stage.removeChild(this._life)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.mouseDown=function(t){this._touchStatus=!0,this._distance.x=t.stageX-t.target.x,this._distance.y=t.stageY-t.target.y,this.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.mouseMove=function(t){if(this._touchStatus)try{t.target.x=t.stageX-this._distance.x,t.target.y=t.stageY-this._distance.y}catch(e){console.log(e)}},e.prototype.mouseUp=function(t){this._touchStatus=!1,this.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.removePlayerIcon=function(t){var e=this,i=t.getUUID();this.soilderIconList.map(function(t,n){t.key==i&&(e.stage.contains(t.icon)&&e.stage.removeChild(t.icon),e.soilderIconList.splice(n,1))})},e.prototype.refrashPlayerIcon=function(){this.soilderIconList.map(function(t,e){t.icon.x=110+68*e})},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,n=t.map(function(t){return i.parse(t)}),o=this.textfield,s=-1,r=function(){s++,s>=n.length&&(s=0);var t=n[s];o.textFlow=t;var i=egret.Tween.get(o);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(r,e)};r()},e}(egret.DisplayObjectContainer);__reflect(Game.prototype,"Game");var House=function(t){function e(e,i){var n=t.call(this)||this;return n.colorMatrix=[.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0],n.game=i,n.createHouse(e),n}return __extends(e,t),e.prototype.createHouse=function(t){this.name=t.name,this.houseBitmap=this.createBitmapByName(t.bitmap),this.houseBitmap.width=150,this.houseBitmap.height=212,this.houseBitmap.touchEnabled=!0,this.addChild(this.houseBitmap),this.touchEnabled=!0,this.id=this.game.game_id,this.joinEos=this.game.join_eos,this.owner=this.game.creator,this.playerList=[],this.createPlayers(this.game.players)},e.prototype.updateHouse=function(t){this.isNewStep=this.game.game_progress!==t.game_progress||this.game.step!==t.step,this.game=t,this.updatePlayers(this.game.players)},e.prototype.updatePlayers=function(t){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(i){switch(i.label){case 0:return[4,t.map(function(t){return __awaiter(e,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.getPlayerByName(t.acc_name)];case 1:return e=i.sent(),null==e?this.createPlayer(t):(e.updatePlayer(t),2==this.game.game_progress&&this.isNewStep&&e.setMoveable(!0)),[2]}})})})];case 1:return i.sent(),[2]}})})},e.prototype.createPlayers=function(t){var e=this;t.map(function(t){e.createPlayer(t)})},e.prototype.createPlayer=function(t){var e=this.playerList.length%2==0?"avtar_male_png":"avtar_female_png",i=new Player(e,t);this.playerList.push(i)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getPlayerByName=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.playerList.filter(function(e){return e.getName()==t})];case 1:return e=i.sent(),e.length>0?[2,e[0]]:[2,null]}})})},e.prototype.getPlayerListByCellId=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.playerList.filter(function(e){return e.getCellId()==t})];case 1:return e=i.sent(),[2,e]}})})},e.prototype.getBitmap=function(){return this.houseBitmap},e.prototype.getPlayerList=function(){return this.playerList},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.destroy=function(){this.houseBitmap=null,this.playerList=[],this.game=null},e.prototype.getID=function(){return this.id},e.prototype.setID=function(t){return this.id=t},e.prototype.getJoinEos=function(){return this.joinEos},e.prototype.getHouseName=function(){return this.name},e.prototype.clearPlayerList=function(){this.playerList=[]},e.prototype.getBoard=function(){return this.game.board},e.prototype.getProgress=function(){return this.game.game_progress},e.prototype.getStep=function(){return this.game.step},e.prototype.getSafeAreaRadius=function(){return this.game.safe_area_radius},e.prototype.getFullPlayersJsonByCellId=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.game.players.filter(function(e){return e.cell_id==t})];case 1:return e=i.sent(),[2,e]}})})},e.prototype.getPlayerJsonList=function(){return this.game.players},e.prototype.getTotalJoinPlayers=function(){return this.game.total_join_players},e.prototype.getDeadPlayers=function(){return this.game.dead_players},e.prototype.getAlivePlayers=function(){return this.game.total_join_players-this.game.dead_players},e.prototype.getEOSInHouse=function(){return this.getTotalJoinPlayers()*parseFloat(this.getJoinEos().substr(0,6))},e.prototype.getWinner=function(){return this.game.winner},e.prototype.getBestKiller=function(){return this.playerList.sort(function(t,e){return e.getKills()-t.getKills()}),this.playerList[0].getName()},e.prototype.getBestEOSWin=function(){return this.playerList.sort(function(t,e){return e.getGold()-t.getGold()}),this.playerList[0].getName()},e.prototype.getOwner=function(){return this.owner},e.prototype.setPlayersMoveable=function(){},e}(egret.DisplayObjectContainer);__reflect(House.prototype,"House");var Item=function(t){function e(e){var i=t.call(this)||this;return i.createItem(e),i}return __extends(e,t),e.prototype.createItem=function(t){this.itemBitMap=this.createBitmapByName(t),this.itemBitMap.width=50,this.itemBitMap.height=50,this.addChild(this.itemBitMap)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getBitmap=function(){return this.itemBitMap},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.getId=function(){return this.id},e.prototype.setId=function(t){this.id=t},e.prototype.destroy=function(){this.itemBitMap=null},e}(egret.DisplayObjectContainer);__reflect(Item.prototype,"Item");var Cell=function(t){function e(e,i,n){var o=t.call(this)||this;return o.cellRect=new egret.Shape,o.task={action:"idle",target:null,status:null},o.position=new egret.Point(0,0),o.item=null,o.hasPoison=!1,o.battleTime=0,o.fallDownSign=!1,o.createCell(e,i,n),o}return __extends(e,t),e.prototype.createCell=function(t,e,i){this.id=i,this.detailBitmap=this.createBitmapByName("show_png"),this.detailBitmap.$setVisible(!1),this.addChild(this.detailBitmap),this.cellRect.graphics.clear(),this.cellRect.graphics.lineStyle(1,0,.3),this.cellRect.graphics.beginFill(16240036,.2),this.cellRect.graphics.drawRect(0,0,80,80),this.cellRect.graphics.endFill(),this.addChild(this.cellRect),this.position=new egret.Point(80*t,80*e),this.x=this.position.x,this.y=this.position.y,this.cell_X_Y={x:t,y:e},this.touchEnabled=!0},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getBitmap=function(){return this.cellBitmap},e.prototype.setTask=function(t){this.task=t},e.prototype.getTask=function(){return this.task},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.destroy=function(){this.cellBitmap=null},e.prototype.getID=function(){return this.id},e.prototype.getXY=function(){return this.cell_X_Y},e.prototype.getItem=function(){return this.item},e.prototype.setItem=function(t){this.item=t},e.prototype.addItem=function(t){this.contains(this.item)&&(this.item.destroy(),this.removeChild(this.item)),this.item=t,this.addChild(this.item)},e.prototype.addPoison=function(t){this.hasPoison=!0,this.addChild(t)},e.prototype.getPoison=function(){return this.hasPoison},e.prototype.setBattleTime=function(t){this.battleTime=t},e.prototype.getBattleTime=function(){return this.battleTime},e.prototype.setIndex=function(t,e){this.setChildIndex(t,e)},e.prototype.hideDetailMode=function(){this.detailBitmap.$setVisible(!1)},e.prototype.showDetailMode=function(t){this.detailBitmap.$setVisible(t)},e.prototype.onDetailMode=function(){return this.detailBitmap.visible},e.prototype.hasFallDownSign=function(){return this.fallDownSign},e.prototype.addFallDownSign=function(t){this.fallDownSign=t},e}(egret.DisplayObjectContainer);__reflect(Cell.prototype,"Cell");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e._touchStatus=!1,e._distance=new egret.Point,e.textfield=new egret.TextField,e.tmxTileMap=tiled.TMXTilemap,e._route=new egret.Shape,e._life=new egret.Shape,e.soilderIconList=[],e.houseList=[],e.board=null,e.backgroundMusic=new egret.Sound,e.playerInfo=new egret.Shape,e.player_name=new egret.TextField,e.player_hp=new egret.TextField,e.player_attack=new egret.TextField,e.player_defense=new egret.TextField,e.player_eos=new egret.TextField,e.player_item=new egret.TextField,e.player_weapon=new egret.TextField,e.messageContainer=new egret.DisplayObjectContainer,e.messageBox=new egret.Shape,e.message=new egret.TextField,e.descriptionContainer=new egret.DisplayObjectContainer,e.descriptionBox=new egret.Shape,e.description=new egret.TextField,e.townRandomName=["johny","kitty","peter"],e.num=0,e.messageTimeout=null,e.canvas=document.getElementsByTagName("CANVAS")[0],e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.createGameScene(),[2]})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,s,r,a=this;return __generator(this,function(h){switch(h.label){case 0:return[4,this.loadResource()];case 1:return h.sent(),t=this.createBitmapByName("city_png"),this.stage.addChild(t),t.width=100,t.height=100,t.x=15,t.y=15,t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.createGame.bind(this,{name:"johny",bitmap:"house_png"}),this),this.login=this.createBitmapByName("login_png"),this.login.x=1180,this.login.y=10,this.login.touchEnabled=!0,this.login.addEventListener(egret.TouchEvent.TOUCH_TAP,this.loginGame,this),this.logout=this.createBitmapByName("logout_png"),this.logout.x=1180,this.logout.y=10,this.logout.touchEnabled=!0,this.logout.addEventListener(egret.TouchEvent.TOUCH_TAP,this.logoutGame,this),ScatterUtils.getIdentity().then(function(t){null==t?a.stage.addChild(a.login):(ScatterUtils.login(),a.stage.addChild(a.logout))}),this.messageContainer.x=600,this.messageContainer.y=200,this.messageContainer.width=350,this.messageContainer.height=250,this.messageBox.graphics.clear(),this.messageBox.graphics.beginFill(16240036,.4),this.messageBox.graphics.lineStyle(2,0,.5),this.messageBox.graphics.drawRoundRect(0,0,350,250,15,15),this.messageBox.graphics.endFill(),this.messageContainer.addChild(this.messageBox),e=new egret.Shape,e.graphics.beginFill(5197647,.8),e.graphics.drawRoundRect(0,0,350,30,15,15),this.messageContainer.addChild(e),i=new egret.TextField,i.x=145,i.y=3,i.size=20,i.textColor=16777215,i.text="通告栏",this.messageContainer.addChild(i),this.message.x=10,this.message.y=35,this.message.width=330,this.message.height=200,this.message.size=20,this.message.textColor=0,this.message.$setWordWrap(!0),this.message.$setMultiline(!0),this.messageContainer.addChild(this.message),n=this.createBitmapByName("description_png"),this.stage.addChild(n),n.x=1350,n.y=10,n.touchEnabled=!0,n.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){a.stage.addChild(a.descriptionContainer)},this),this.descriptionContainer.x=350,this.descriptionContainer.y=60,this.descriptionContainer.width=800,this.descriptionContainer.height=1e3,this.descriptionBox.graphics.clear(),this.descriptionBox.graphics.beginFill(16240036,.8),this.descriptionBox.graphics.lineStyle(2,0,.8),this.descriptionBox.graphics.drawRoundRect(0,0,800,1e3,15,15),this.descriptionBox.graphics.endFill(),this.descriptionContainer.addChild(this.descriptionBox),o=new egret.Shape,o.graphics.beginFill(5197647,.8),o.graphics.drawRoundRect(0,0,800,30,15,15),this.descriptionContainer.addChild(o),s=new egret.TextField,s.x=350,s.y=5,s.size=20,s.textColor=16777215,s.text="游戏说明",this.descriptionContainer.addChild(s),r=this.createBitmapByName("close_png"),this.descriptionContainer.addChild(r),r.x=770,r.y=0,r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){a.stage.removeChild(a.descriptionContainer)},this),this.description.x=10,this.description.y=35,this.description.width=780,this.description.height=980,this.description.size=22,this.description.textColor=0,this.description.$setWordWrap(!0),this.description.$setMultiline(!0),this.description.textFlow=(new egret.HtmlTextParser).parser("游戏规则说明：\n\n1. 进入游戏大厅，点击左上角按钮弹出scatter界面，确认后创建新的一局游戏，新局将出现在游戏大厅中，新局的创建者叫局主；\n\n2. 在游戏大厅中点击新建的游戏，进入游戏界面；\n\n3. 游戏的局主点击左列中间按钮随机出该局的地图道具分布；\n\n4. 之后，其他玩家可以选择地图上的某个格子位置，点击弹出scatter界面，确认后加入游戏，玩家的角色将空降到该地图格子中；\n\n5. 局主可以在参与人数达到2人或2人以上的情况下，随时点击左列“开始游戏”按钮来开局（在设置地图道具后半小时内未开局的情况下系统将自动关闭游戏）；\n\n6. 游戏将以30秒间隔的时间节奏来推进游戏，所有参与玩家可以在30秒内移动一步（或原地不动），30秒后游戏将做出一轮判决，直到判决出游戏的最终胜利者结束；\n\n7. 地图上有毒气圈，每3分钟向内扩大一圈，凡是处于毒气圈内的玩家将会受到伤害；\n\n8. 地图上分布有各类道具，玩家移动进入地图格子时，可以立即拾取枪械或防具，或触发地图事件（如武器空投）；\n\n9. 当同一格子内有多名玩家时，每30秒一轮的判决将会让玩家相互攻击；\n\n10. 当有一半玩家阵亡时，地图上将会在某个格子上空投EOS（空投发生时，该格子上的玩家将被全部杀死）；\n\n11. 击杀其他玩家，可获得被击杀玩家身上一定比例的EOS，以及额外的击杀奖励；\n\n12. 击杀数最高的玩家，将会获得“杀手”的奖励，游戏的最后一名玩家，将会获得“胜利者”的奖励 \n\n另外，关于scatter钱包的设置，请参考：\n1. <a href = 'https://get-scatter.com'><u>https://get-scatter.com</u></a> \n2. <a href = 'https://chrome.google.com/webstore/detail/scatter/ammjpmhgckkpcamddpolhchgomcojkle'><u>https://chrome.google.com/webstore/detail/scatter/ammjpmhgckkpcamddpolhchgomcojkle </u></a>"),this.description.scrollV=0,this.descriptionContainer.addChild(this.description),this.stage.addChild(this.textfield),this.refreshHouseList(),[2]}})})},e.prototype.popMessageBox=function(t){var e=this;egret.clearTimeout(this.messageTimeout),this.messageTimeout=egret.setTimeout(function(){e.message.text="",e.stage.removeChild(e.messageContainer)},this,4e3),this.stage.addChild(this.messageContainer),this.message.text=t},e.prototype.refreshHouseList=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return[4,ScatterUtils.getAllGamesInfo().then(function(e){return __awaiter(t,void 0,void 0,function(){var t=this;return __generator(this,function(i){switch(i.label){case 0:return[4,this.houseList.map(function(e){t.stage.contains(e)&&(t.stage.removeChild(e),e.destroy(),e=null)})];case 1:return i.sent(),this.houseList=[],console.log(e),e.rows?[4,e.rows.map(function(e,i){t.createHouse({name:"johny",bitmap:"game_png"},e).then(function(e){e.setPosition(new egret.Point(170*(1+i),50)),t.stage.addChild(e),t.houseList.push(e)})})]:[3,3];case 2:return i.sent(),[3,4];case 3:this.popMessageBox("无游戏信息"),i.label=4;case 4:return[2]}})})})["catch"](function(e){console.error(e),t.popMessageBox("获取游戏信息失败")})];case 1:return e.sent(),[2]}})})},e.prototype.createGame=function(){var t=this;ScatterUtils.getIdentity().then(function(e){return null==e?void t.popMessageBox(ScatterUtils.message.authority):void ScatterUtils.createGame("1.0000 EOS").then(function(e){console.log("create",e),e.processed?t.refreshHouseList():(e=JSON.parse(e),t.popMessageBox("创建游戏失败:"+e.error.details[0].message))})["catch"](function(e){console.log(e),t.popMessageBox("取消创建游戏")})})},e.prototype.createHouse=function(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){return i=new House(t,e),i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){var t=i.getID();document.location.href="game.html?id="+t},this),[2,i]})})},e.prototype.loginGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.login().then(function(e){e.login?(alert("欢迎: "+e.details),t.stage.contains(t.login)&&t.stage.removeChild(t.login),t.stage.contains(t.logout)||t.stage.addChild(t.logout)):alert(e.details)})["catch"](function(e){console.log("e",e),t.popMessageBox(e)}),[2]})})},e.prototype.logoutGame=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return ScatterUtils.logout().then(function(e){alert(e.details),e.logout&&(t.stage.contains(t.logout)&&t.stage.removeChild(t.logout),t.stage.contains(t.login)||t.stage.addChild(t.login))})["catch"](function(t){console.log("e",t),alert(t)}),[2]})})},e.prototype.animation=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){return e=new egret.MovieClipDataFactory(RES.getRes(t.json),RES.getRes(t.png)),i=new egret.MovieClip(e.generateMovieClipData(t.data)),i.x=t.x,i.y=t.y,[2,i]})})},e.prototype.recall=function(t){if(t||(t=this.selectedPlayer),t){this.unmountMovement(),this.clearRoute(t.getTask().action);var e=t.getTask().status,i=t.getHouse(),n=i.getPosition(),o=t.getBitmap();egret.Tween.removeTweens(o),e&&"completed"==e?egret.Tween.get(o).to(n,1e3,egret.Ease.sineIn):egret.Tween.get(o).to(n,0,egret.Ease.sineIn),t.setTask({action:"idle",target:null,status:null})}},e.prototype.initTask=function(t){var e=this;this.selectedPlayer?(this.unmountMovement(),this.selectedPlayer.setTask({action:t,target:null,status:null}),setTimeout(function(){e.mountMovement()},300)):console.log("no warrior selected")},e.prototype.showLife=function(t,e){var i,n=e.getLife();i=n.remain>=.6*n.full?60928:n.remain>=.4*n.full&&n.remain<.6*n.full?16776960:16711680,this._life.graphics.clear(),this._life.graphics.lineStyle(4,i),this._life.graphics.moveTo(e.getPosition().x,e.getPosition().y),this._life.graphics.lineTo(e.getPosition().x+n.remain,e.getPosition().y),t.addChild(this._life)},e.prototype.showText=function(t,e){this.textfield.x=e.x,this.textfield.y=e.y,this.textfield.size=22,this.textfield.textColor=0,this.textfield.text=t},e.prototype.actionSound=function(t){var e=new egret.Sound;e.addEventListener(egret.Event.COMPLETE,function(t){e.play(0,1)},this),e.load(t)},e.prototype.backgroundSound=function(t){this.backgroundMusicChannel&&this.backgroundMusicChannel.stop(),this.backgroundMusic.addEventListener(egret.Event.COMPLETE,this.play,this),this.backgroundMusic.load(t)},e.prototype.play=function(){this.backgroundMusicChannel=this.backgroundMusic.play(0,0)},e.prototype.movePlayer=function(t){if(console.log("moving"),null!=this.selectedPlayer&&"undefined"!=typeof this.selectedPlayer){this.stage.contains(this._life)&&this.stage.removeChild(this._life);var e=this.selectedPlayer.getBitmap();egret.Tween.removeTweens(e);var i={x:e.x,y:e.y},n={x:t.stageX,y:t.stageY},o=this.selectedPlayer.getTask().action;this.drawRoute(i,n,o);var s={x:t.stageX-17,y:t.stageY-25};egret.Tween.get(e).to(s,3e3,egret.Ease.sineIn).wait(500).call(this.doAction.bind(this,this.selectedPlayer,o,s,n))}},e.prototype.mountMovement=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.unmountMovement=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.movePlayer,this)},e.prototype.doAction=function(t,e,i,n){var o=this;this.clearRoute(e);var s=t.getTask().target,r=null==s||null==s.getBitmap()?!1:s.getBitmap().hitTestPoint(n.x,n.y,!0);if(console.log("execute="+r),r){var a=this.createBitmapByName("sword_png");a.x=i.x,a.y=i.y,this.stage.addChild(a),"attack"==e?this.attackTarget(i).then(function(){t.setTask({action:"attack",target:null,status:"completed"}),o.recall(t)}):t.setTask({action:"enforce",target:s,status:"completed"}),setTimeout(function(){o.stage.removeChild(a),a=null},1e3)}else t.setTask({action:"idle",target:null})},e.prototype.attackTarget=function(t){var e=this,i=new egret.MovieClipDataFactory(RES.getRes("fight_json"),RES.getRes("fight_png")),n=new egret.MovieClip(i.generateMovieClipData("fight"));n.x=t.x,n.y=t.y,n.width=50,n.height=50,this.board.addChild(n),n.play(20),this.actionSound(RES.getRes("shooting_mp3").url);var o=new egret.MovieClipDataFactory(RES.getRes("money_json"),RES.getRes("money_png")),s=new egret.MovieClip(o.generateMovieClipData("money"));return s.x=t.x,s.y=t.y-30,this.board.addChild(s),s.play(2),this.actionSound(RES.getRes("destroyhuman_wav").url),setTimeout(function(){e.board.removeChild(s)},2e3),new Promise(function(t,i){setTimeout(function(){e.board.removeChild(n),e.board.contains(e._life)&&e.board.removeChild(e._life),t()},1e3)})},e.prototype.drawRoute=function(t,e,i){this.clearRoute(i);var n,o,s;switch(i){case"attack":n=16711680,o=25,s=25;break;case"enforce":n=60928,o=10,s=50;break;default:n=16776960,o=10,s=50}this._route.graphics.lineStyle(2,n),this._route.graphics.moveTo(t.x,t.y),this._route.graphics.lineTo(e.x,e.y),this[i].x=e.x-o,this[i].y=e.y-s,this.stage.addChild(this[i])},e.prototype.clearRoute=function(t){this._route.graphics.clear(),this.stage.contains(this[t])&&this.stage.removeChild(this[t]),this.stage.contains(this._life)&&this.stage.removeChild(this._life)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.mouseDown=function(t){this._touchStatus=!0,this._distance.x=t.stageX-t.target.x,this._distance.y=t.stageY-t.target.y,this.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.mouseMove=function(t){if(this._touchStatus)try{t.target.x=t.stageX-this._distance.x,t.target.y=t.stageY-this._distance.y}catch(e){console.log(e)}},e.prototype.mouseUp=function(t){this._touchStatus=!1,this.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.mouseMove,this)},e.prototype.removePlayerIcon=function(t){var e=this,i=t.getUUID();this.soilderIconList.map(function(t,n){t.key==i&&(e.stage.contains(t.icon)&&e.stage.removeChild(t.icon),e.soilderIconList.splice(n,1))})},e.prototype.refrashPlayerIcon=function(){this.soilderIconList.map(function(t,e){t.icon.x=110+68*e})},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,n=t.map(function(t){return i.parse(t)}),o=this.textfield,s=-1,r=function(){s++,s>=n.length&&(s=0);var t=n[s];o.textFlow=t;var i=egret.Tween.get(o);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(r,e)};r()},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var Player=function(t){function e(e,i){var n=t.call(this)||this;return n.task={action:"idle",target:null,status:null},n.position=new egret.Point(0,0),n.items=[],n.createPlayer(e,i),n}return __extends(e,t),e.prototype.createPlayer=function(t,e){this.playerBitmap=this.createBitmapByName(t),this.playerBitmap.width=70,this.playerBitmap.height=70,this.playerProfile=this.createBitmapByName("profile_"+t),t.indexOf("female")>=0?this.setGentle(1):this.setGentle(0),this.addChild(this.playerBitmap),this.setName(e.acc_name),this.setCellId(e.cell_id),this.setArmor(e.armor),this.setAttack(e.attack),this.setLife(e.hp),this.setDefense(e.defense),this.setItems(e.items),this.setWeapon(e.weapon),this.setGold(e.win_eos),this.setKills(e.kill_count)},e.prototype.updatePlayer=function(t){this.setCellId(t.cell_id),this.setArmor(t.armor),this.setAttack(t.attack),this.setLife(t.hp),this.setDefense(t.defense),this.setItems(t.items),this.setWeapon(t.weapon),this.setGold(t.win_eos),this.setKills(t.kill_count)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.getBitmap=function(){return this.playerBitmap},e.prototype.getPlayerProfile=function(){return this.playerProfile},e.prototype.setTask=function(t){this.task=t},e.prototype.getTask=function(){return this.task},e.prototype.getHouse=function(){return this.house},e.prototype.getPosition=function(){var t={x:this.x,y:this.y};return t},e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e.prototype.getName=function(){return this.accName},e.prototype.setName=function(t){this.accName=t},e.prototype.getLife=function(){return this.hp},e.prototype.setLife=function(t){this.hp=t},e.prototype.destroy=function(){this.playerBitmap=null},e.prototype.getUUID=function(){return this.uuid},e.prototype.getGold=function(){return this.gold},e.prototype.setGold=function(t){this.gold=t},e.prototype.getCellId=function(){return this.cell_id},e.prototype.setCellId=function(t){this.cell_id=t},e.prototype.getArmor=function(){return this.armor},e.prototype.setArmor=function(t){this.armor=t},e.prototype.getAttack=function(){return this.attack},e.prototype.setAttack=function(t){this.attack=t},e.prototype.getDefense=function(){return this.defense},e.prototype.setDefense=function(t){this.defense=t},e.prototype.getWeapon=function(){return this.weapon},e.prototype.setWeapon=function(t){this.weapon=t},e.prototype.getItems=function(){return this.items},e.prototype.setItems=function(t){this.items=t},e.prototype.isAlive=function(){return this.getLife()>0?!0:!1},e.prototype.getKills=function(){return this.kills},e.prototype.setKills=function(t){this.kills=t},e.prototype.setMoveable=function(t){this.moveable=t},e.prototype.isMoveable=function(){return this.moveable},e.prototype.setGentle=function(t){this.gentle=t},e.prototype.getGentle=function(){return this.gentle
},e}(egret.DisplayObjectContainer);__reflect(Player.prototype,"Player");var ScatterUtils=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.getEOS=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return null==this.eos?[2,Eos(this.config)]:[2,this.eos]})})},e.connect=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this,[4,ScatterJS.scatter.connect("scatter")];case 1:return t.connected=e.sent(),[2,this.connected]}})})},e.login=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i=this;return __generator(this,function(n){switch(n.label){case 0:return[4,this.connect()];case 1:if(n.sent(),!this.connected)return console.log("not connected"),[2,{login:!1,details:this.message.nowallet}];n.label=2;case 2:return n.trys.push([2,4,,5]),[4,ScatterJS.scatter.getIdentity({accounts:[this.network.EOS]}).then(function(t){return console.log("identities",t,ScatterJS.scatter.identity),i.currentAccount=t.accounts[0],i.eos=ScatterJS.scatter.eos(i.network.EOS,Eos),{login:!0,details:i.currentAccount.name}})];case 3:return t=n.sent(),[2,t];case 4:return e=n.sent(),[2,{login:!1,details:"未能使用钱包，可能是"+this.message.walletlock+"或者"+this.message.noidentity}];case 5:return[2]}})})},e.getAccountInfo=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return null!=this.eos?[3,2]:(t=this,[4,this.getEOS()]);case 1:t.eos=i.sent(),i.label=2;case 2:return[4,this.eos.getAccount(this.currentAccount.name).then(function(t){return console.log(t),t})["catch"](function(t){return t})];case 3:return e=i.sent(),[2,e]}})})},e.getAllGamesInfo=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return null!=this.eos?[3,2]:(t=this,[4,this.getEOS()]);case 1:t.eos=i.sent(),i.label=2;case 2:return[4,this.eos.getTableRows({json:!0,scope:this.contact.jungle,code:this.contact.jungle,table:"games"}).then(function(t){return console.log(t),t})["catch"](function(t){return t})];case 3:return e=i.sent(),[2,e]}})})},e.getGameInfo=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){switch(n.label){case 0:return null!=this.eos?[3,2]:(e=this,[4,this.getEOS()]);case 1:e.eos=n.sent(),n.label=2;case 2:return[4,this.eos.getTableRows({json:!0,scope:this.contact.jungle,code:this.contact.jungle,table:"games",limit:1,lower_bound:t,upper_bound:t+1}).then(function(t){return t})["catch"](function(t){return t})];case 3:return i=n.sent(),[2,i]}})})},e.createGame=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.eos.transaction({actions:[{account:"eosio.token",name:"transfer",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{from:this.currentAccount.name,to:this.contact.jungle,quantity:t,memo:""}}]}).then(function(t){return t})["catch"](function(t){return t})];case 1:return e=i.sent(),[2,e]}})})},e.joinGame=function(t,e,i,n){return __awaiter(this,void 0,void 0,function(){var o;return __generator(this,function(s){switch(s.label){case 0:return[4,this.eos.transaction({actions:[{account:"eosio.token",name:"transfer",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{from:this.currentAccount.name,to:this.contact.jungle,quantity:e,memo:t+","+i+","+n}}]}).then(function(t){return console.log("res",t),t})["catch"](function(t){return t})];case 1:return o=s.sent(),[2,o]}})})},e.setMap=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,fetch("http://114.115.135.201:52919/api?a=setmap&game_id="+t,{method:"GET"}).then(function(t){return t.json()}).then(function(t){return console.log(t),t})];case 1:return e=i.sent(),[2,e]}})})},e.kickOff=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.eos.transaction({actions:[{account:this.contact.jungle,name:"kickoff",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{who:this.currentAccount.name,game_id:t}}]}).then(function(t){return t})["catch"](function(t){return t})];case 1:return e=i.sent(),[2,e]}})})},e.move=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(o){switch(o.label){case 0:return[4,this.eos.transaction({actions:[{account:this.contact.jungle,name:"move",authorization:[{actor:this.currentAccount.name,permission:"active"}],data:{who:this.currentAccount.name,game_id:t,row:e,column:i}}]}).then(function(t){return t})["catch"](function(t){return t})];case 1:return n=o.sent(),[2,n]}})})},e.logout=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){try{return t=this.currentAccount.name,ScatterJS.scatter.forgetIdentity(),this.currentAccount=null,this.eos=null,[2,{logout:!0,details:t+this.message.logout}]}catch(i){return console.log(i),[2,{logout:!1,details:"登出失败"}]}return[2]})})},e.getCurrentAccountName=function(){return null!=this.currentAccount?this.currentAccount.name:null},e.getIdentity=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,ScatterJS.scatter.identity]})})},e.nowseconds=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("http://114.115.135.201:52920/api/?a=now",{method:"GET"}).then(function(t){return t.json()}).then(function(t){return t})];case 1:return t=e.sent(),[2,t]}})})},e.eos=null,e.connected=!1,e.currentAccount=null,e.message={authority:"未授权用户，请先登录",walletlock:"钱包已上锁",noidentity:"未验证钱包身份",nowallet:"亲，还没有装钱包哟",login:"已登陆游戏",logout:"已登出游戏"},e.chain={main:"aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906",jungle:"e70aaab8997e1dfce58fbfac80cbbb8fecec7b99cf982a9444273cbc64c41473",dev:"cf057bbfb72640471fd910bcb67639c22df9f92470936cddc1ade0e2f2e7dc4f"},e.Blockchains={EOSIO:"eos",Ethereum:"eth",Tron:"trx"},e.contact={jungle:"eat1chicken2"},e.network={EOS:{blockchain:"eos",protocol:"http",host:"121.168.149.101",port:8888,chainId:e.chain.jungle},ETH:{blockchain:"eth",protocol:"http",host:"114.115.135.201",port:8888,chainId:e.chain.dev},TRX:{blockchain:"trx",protocol:"http",host:"114.115.135.201",port:8888,chainId:e.chain.dev}},e.config={keyProvider:["5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3","5KRF8dr2fvHx9dVQyBqWwYhs7KvT8UdCb8Fy6hpWqHp6yZ1K6T3"],httpEndpoint:"http://121.168.149.101:8888",chainId:e.chain.jungle,expireInSeconds:60,broadcast:!0,debug:!1,sign:!0},e}(Object);__reflect(ScatterUtils.prototype,"ScatterUtils");